# Progress Tracker: ADR-009 Phase 2

## Project Context

Feature: ADR-009 Phase 2 - Flows Schema Migration & Frontend Integration
Started: 2026-01-10
Branch: yellow/adr-009-phase2
Workspace: ralph/workspaces/adr-009-phase2_2026-01-10/

## What We're Building

Migrate `flows.branch_condition` JSONB to flattened columns and complete frontend migration from `flowMembership` to `flowId`.

### Key Changes

1. **Database**: Flattened branch columns with FK to form_questions
2. **Hasura**: Updated permissions and new relationship
3. **GraphQL**: Updated fragments, new queries/mutations
4. **Types**: BranchValue discriminated union
5. **Frontend**: 16+ files migrated from flowMembership to flowId

## Tech Stack

- Frontend: Vue 3 + Vite + TypeScript + Tailwind CSS
- Backend: Hono.js REST API + Hasura GraphQL
- Database: PostgreSQL
- Package Manager: pnpm

## Key Patterns

- FSD architecture for frontend
- GraphQL types from @/shared/graphql/generated/operations
- Entity composables pattern (useEntity)
- Hasura migrations at db/hasura/migrations/default/

## Source Documents

- ADR: docs/adr/009-flows-table-branching-architecture.md
- Implementation Plan: docs/implementation-plans/009-phase-2-flows-schema-and-frontend.md

## Skill References

- DB-* tasks: /hasura-migrations
- GQL-* tasks: /graphql-code
- PERM-* tasks: /hasura-permissions

---

## Iteration Log

### Iteration 1 - DB-001 - 2026-01-10
- [x] Add flattened branch columns to flows table
- Learnings: Must delete existing flows before migration due to CHECK constraint. Hasura metadata export removes stale column references.
- Files changed:
  - db/hasura/migrations/default/1768018541454_1768018533000_2026_01_10_0945__flows__add_branch_columns/up.sql
  - db/hasura/migrations/default/1768018541454_1768018533000_2026_01_10_0945__flows__add_branch_columns/down.sql

### Iteration 2 - DB-002 - 2026-01-10
- [x] Add step-question cascade trigger
- Learnings: AFTER DELETE trigger with EXECUTE FUNCTION pattern. Function checks for null question_id before deletion.
- Files changed:
  - db/hasura/migrations/default/1768018796784_1768018789000_2026_01_10_0949__form_steps__add_question_cascade_trigger/up.sql
  - db/hasura/migrations/default/1768018796784_1768018789000_2026_01_10_0949__form_steps__add_question_cascade_trigger/down.sql

### Iteration 3 - PERM-001 - 2026-01-10
- [x] Update Hasura permissions for new flow columns
- Learnings: Using columns: '*' auto-includes new columns. Just needed to add branch_question object_relationship.
- Files changed:
  - db/hasura/metadata/databases/default/tables/public_flows.yaml

### Iteration 4 - GQL-001 - 2026-01-10
- [x] Update FlowBasic fragment with new columns
- Learnings: Removed deprecated branch_condition, added 4 flattened columns. Codegen updated types automatically.
- Files changed:
  - apps/web/src/entities/flow/graphql/fragments/FlowBasic.gql

### Iteration 5 - GQL-002 - 2026-01-10
- [x] Add GetFlowsByBranchQuestion query
- Files changed:
  - apps/web/src/entities/flow/graphql/queries/getFlowsByBranchQuestion.gql

### Iteration 6 - GQL-003 - 2026-01-10
- [x] Add UpdateFlow and DeleteFlow mutations
- Files changed:
  - apps/web/src/entities/flow/graphql/mutations/updateFlow.gql
  - apps/web/src/entities/flow/graphql/mutations/deleteFlow.gql

### Iteration 7 - TS-001 - 2026-01-10
- [x] Create BranchValue type definitions
- Learnings: Also fixed useCreateFormWithSteps.ts to use new columns instead of deprecated branch_condition.
- Files changed:
  - apps/web/src/entities/flow/models/branchValue.ts (created)
  - apps/web/src/entities/flow/models/index.ts (updated barrel export)
  - apps/web/src/features/createForm/composables/useCreateFormWithSteps.ts (fixed for new columns)

### Iteration 8 - FE-001 - 2026-01-10
- [x] Create useGetFlowsByBranchQuestion composable
- Files changed:
  - apps/web/src/entities/flow/composables/queries/useGetFlowsByBranchQuestion.ts (created)
  - apps/web/src/entities/flow/composables/queries/index.ts (created)
  - apps/web/src/entities/flow/composables/index.ts (added queries export)

### Iteration 9 - FE-002 - 2026-01-10
- [x] Create useUpdateFlow and useDeleteFlow composables
- Files changed:
  - apps/web/src/entities/flow/composables/mutations/useUpdateFlow.ts (created)
  - apps/web/src/entities/flow/composables/mutations/useDeleteFlow.ts (created)
  - apps/web/src/entities/flow/composables/mutations/index.ts (updated)

### Iteration 10 - FE-003 - 2026-01-10
- [x] Update useCreateFlows to use new columns
- Learnings: Mutation uses generated flows_insert_input which auto-includes new columns. Consumer already updated in TS-001.
- Files changed: None additional (covered by TS-001)

### Iteration 11 - FE-004 - 2026-01-10
- [x] Update stepTransform.ts to include flowId
- Learnings: Made flowId optional in FormStep interface for backward compatibility. Updated multiple files that create FormStep objects.
- Files changed:
  - apps/web/src/shared/stepCards/models/stepContent.ts (added optional flowId)
  - apps/web/src/features/createForm/functions/stepTransform.ts (added flowId mapping)
  - apps/web/src/features/createForm/composables/timeline/useStepOperations.ts (updated createStep, addStepAt)

### Iteration 12 - Code Review Fixes - 2026-01-10
- [x] Refactor useStepOperations.ts to use object params for functions with >2 args
- [x] Update useTimelineStepCrud.ts callers for new signatures
- [x] Add explicit return types to flow composables
- [x] Fix TODO comment reference (FE-003 → FE-005)
- [x] Add object params rule to code-review skill
- Commits:
  - 164c281: docs(skill): add object params rule to code-review checklist
  - 86fa98c: refactor(createForm): use object params for step operations
  - 83e923c: feat(flow): add explicit return types to composables
  - 01abea1: fix(createForm): correct TODO story reference FE-003 to FE-005

### Iteration 13 - FE-005 - 2026-01-10
- [x] Update useCreateFormWithSteps to create branch flows with new schema
- Learnings: Questions must be created BEFORE flows so branch_question_id FK can reference them.
  Flow creation order: form → questions → flows (with branch_question_id) → steps
- Files changed:
  - apps/web/src/features/createForm/composables/useCreateFormWithSteps.ts
- Notes: Wizard flow now creates proper branch flows. Editor flow deferred to FE-009.

### Summary - Phase 2 Session 3 - 2026-01-10
- Stories completed: DB-001 to FE-005 (12/20)
- Stories deferred: FE-006 to FE-012 (7/20 - require editor flow refactoring)
- Stories partial: TEST-001 (build/typecheck pass, functional tests pending)
- Code review fixes: 4 commits for object params, return types, TODO fix
- Status: pnpm typecheck ✓, pnpm build ✓

## Deferred Work (Phase 3 Candidates)

FE-006 to FE-012 require:
- Integrating useDeleteFlow into useBranchingDisable for editor flow
- Full flowId usage across timeline composables
- Question deletion protection UI
- Editor flow branch creation (useTimelineBranching)

These are deferred because:
1. flowId is optional during migration (backward compatible)
2. Existing flowMembership logic still works for UI
3. Steps from DB get flowId via stepTransform
4. Core infrastructure (types, composables, mutations) is in place
5. Wizard flow now creates proper branch flows (FE-005 complete)
